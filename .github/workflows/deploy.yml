name: OSU VPN SSO Deployment

on:
  push:
    branches: [main]

jobs:
  vpn-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install VPN and SSO Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y openconnect python3-pyqt5 python3-pyqt5.qtwebengine xvfb
          pip3 install openconnect-sso

      - name: Configure openconnect-sso
        run: |
          mkdir -p ~/.config/openconnect-sso
          cat > ~/.config/openconnect-sso/config.toml << EOF
          [openconnect]
          server = "${{ secrets.VPN_HOST }}"
          authgroup = "${{ secrets.VPN_GROUP }}"
          user = "${{ secrets.VPN_USER }}"

          [credentials]
          password = "${{ secrets.VPN_PASS }}"
          EOF

      - name: Connect to VPN (Headless SSO)
        run: |
          # xvfb-run creates a virtual screen for the SSO browser
          # Run with --browser-display-mode hidden to suppress browser window
          xvfb-run openconnect-sso \
            --browser-display-mode hidden \
            -- --background &

          VPN_PID=$!

          # Wait for VPN connection and Duo Push approval
          echo "Waiting for VPN connection and Duo Push approval..."
          echo ">>> APPROVE DUO PUSH NOW <<<"
          sleep 30

          # Check if VPN is connected
          if ip addr show tun0 &>/dev/null; then
            echo "VPN connected successfully!"
          else
            echo "VPN may not be connected, continuing anyway..."
          fi

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Server
        run: |
          # Sync source files (excluding node_modules, dist, .git, .env)
          rsync -avz --delete \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='.git' \
            --exclude='.env' \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/CS340/activity2/

          # SSH in and rebuild
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            cd ~/CS340/activity2

            # Stop existing server
            npx forever stop dist/server/entry.mjs 2>/dev/null || true

            # Install dependencies and build
            npm install
            npm run build

            # Start server
            HOST=0.0.0.0 PORT=8742 npx forever start dist/server/entry.mjs

            echo "Deployment complete!"
          ENDSSH

      - name: Disconnect VPN
        if: always()
        run: |
          sudo pkill openconnect || true
          sudo pkill openconnect-sso || true
