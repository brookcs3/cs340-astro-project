---
// CS340 Project Step 3 - Group 101
// Platforms page: Browse, Add, Update, Delete gaming platforms

import Layout from '../layouts/Layout.astro';
import { getConnection } from '../lib/db';

let platforms: any[] = [];
let error = '';

try {
  const db = await getConnection();
  const [rows] = await db.execute('SELECT platformID, name FROM Platforms ORDER BY platformID');
  platforms = rows as any[];
  await db.end();
} catch (e: any) {
  error = e.message;
}
---

<Layout title="Platforms">
  <h1 class="page-title">Platforms</h1>

  {error && <p style="color: red;">Database error: {error}</p>}

  <!-- Browse All Platforms -->
  <div class="section-card">
    <h2>Browse All Platforms</h2>
    <p>All gaming platforms (hardware/environments) registered in the database.</p>
    <table>
      <thead>
        <tr>
          <th>Platform ID</th>
          <th>Name</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {platforms.length === 0 && (
          <tr><td colspan="3" style="text-align:center; color:#9ca3af;">No platforms found.</td></tr>
        )}
        {platforms.map((platform) => (
          <tr>
            <td>{platform.platformID}</td>
            <td>{platform.name}</td>
            <td>
              <div class="actions">
                <button class="btn btn-warning btn-sm" onclick={`document.getElementById('edit-id').value='${platform.platformID}'; document.getElementById('edit-name').value='${platform.name.replace(/'/g, "\\'")}'; document.getElementById('edit-section').scrollIntoView({behavior:'smooth'})`}>Edit</button>
                <form method="POST" action="/platforms" style="display:inline;">
                  <input type="hidden" name="action" value="delete" />
                  <input type="hidden" name="platformID" value={platform.platformID} />
                  <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>
              </div>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>

  <!-- Add New Platform -->
  <div class="section-card">
    <h2>Add New Platform</h2>
    <p>Add a new gaming platform to the database.</p>
    <form method="POST" action="/platforms">
      <input type="hidden" name="action" value="insert" />
      <div class="form-grid">
        <div class="form-group">
          <label for="add-name">Platform Name *</label>
          <input type="text" id="add-name" name="name" required maxlength="100" placeholder="e.g. PlayStation 5" />
          <span class="hint">Unique platform name (max 100 characters)</span>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Add Platform</button>
    </form>
  </div>

  <!-- Update Existing Platform -->
  <div class="section-card" id="edit-section">
    <h2>Update Existing Platform</h2>
    <p>Select a platform from the table above by clicking "Edit", then modify the name below.</p>
    <form method="POST" action="/platforms">
      <input type="hidden" name="action" value="update" />
      <div class="form-grid">
        <div class="form-group">
          <label for="edit-id">Platform ID</label>
          <input type="number" id="edit-id" name="platformID" required readonly placeholder="Click Edit on a row above" />
          <span class="hint">Auto-filled when clicking Edit</span>
        </div>
        <div class="form-group">
          <label for="edit-name">Platform Name *</label>
          <input type="text" id="edit-name" name="name" required maxlength="100" />
        </div>
      </div>
      <button type="submit" class="btn btn-warning">Update Platform</button>
    </form>
  </div>
</Layout>
